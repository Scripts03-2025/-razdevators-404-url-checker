/**
 * üì® Telegram Notification Script
 * ------------------------------------
 * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç Google –¢–∞–±–ª–∏—Ü—É –≤–æ –≤–∫–ª–∞–¥–∫–µ "404 (–Ω–µ –º–µ–Ω—è—Ç—å!)" –Ω–∞—á–∏–Ω–∞—è —Å 7-–π —Å—Ç—Ä–æ–∫–∏.
 * –ï—Å–ª–∏ –≤ –∫–æ–ª–æ–Ω–∫–µ B –Ω–∞–π–¥–µ–Ω–∞ –Ω–æ–≤–∞—è —Å—Å—ã–ª–∫–∞ (–±–µ–∑ –ø–æ–º–µ—Ç–∫–∏ –≤ –∫–æ–ª–æ–Ω–∫–µ C),
 * —Ç–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Telegram –∏ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –ø–æ–º–µ—Ç–∫—É –≤–∏–¥–∞:
 * "–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ 25.03.2025 16:00" –≤ –∫–æ–ª–æ–Ω–∫—É C.
 * –†–∞–±–æ—Ç–∞–µ—Ç —Å —Ç—Ä–∏–≥–≥–µ—Ä–æ–º –∫–∞–∂–¥—ã–µ 4 —á–∞—Å–∞.
 * 
 * üîÑ –í–µ—Ä—Å–∏–∏:
 * v1.0.0 ‚Äî –ë–∞–∑–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è (–æ—Ç–ø—Ä–∞–≤–∫–∞ –Ω–æ–≤—ã—Ö —Å—Å—ã–ª–æ–∫ –∏ –ø–æ–º–µ—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–∏)
 * v1.1.0 ‚Äî –î–æ–±–∞–≤–ª–µ–Ω–æ –æ–ø–∏—Å–∞–Ω–∏–µ –∏ –ª–æ–≥ –≤–µ—Ä—Å–∏–π (25.03.2025)
 */

const TELEGRAM_TOKEN = '8136586676:AAHvXeM4ih9ECPdSwzGM5P0O1p2_GYb_iTk';
const TELEGRAM_CHAT_ID = '8003377702'; // ‚Üê —Ç–≤–æ–π chat_id

function checkNewLinksAndNotify() {
  const sheetName = '404 (–Ω–µ –º–µ–Ω—è—Ç—å!)';
  const linkColumn = 2; // –∫–æ–ª–æ–Ω–∫–∞ B
  const statusColumn = 3; // –∫–æ–ª–æ–Ω–∫–∞ C

  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(sheetName);
  const data = sheet.getRange(7, linkColumn, sheet.getLastRow() - 6).getValues(); // –Ω–∞—á–∏–Ω–∞—è —Å 7-–π —Å—Ç—Ä–æ–∫–∏
  const statuses = sheet.getRange(7, statusColumn, data.length).getValues();

  for (let i = 0; i < data.length; i++) {
    const url = data[i][0];
    const status = statuses[i][0];

    if (url && !status) {
      const message = `üì∞ –ù–æ–≤—ã–π —Ç–µ–∫—Å—Ç —Ä–∞–∑–º–µ—â—ë–Ω:\n${url}`;
      sendTelegramMessage(message);

      const now = new Date();
      const formattedTime = Utilities.formatDate(now, Session.getScriptTimeZone(), 'dd.MM.yyyy HH:mm');
      const statusMessage = `–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ ${formattedTime}`;
      sheet.getRange(i + 7, statusColumn).setValue(statusMessage); // –ü–∏—à–µ–º –≤ C
      SpreadsheetApp.flush();
    }
  }
}

function sendTelegramMessage(message) {
  const url = `https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage`;
  const payload = {
    chat_id: TELEGRAM_CHAT_ID,
    text: message,
    parse_mode: 'Markdown'
  };

  const options = {
    method: 'post',
    contentType: 'application/json',
    payload: JSON.stringify(payload),
    muteHttpExceptions: true,
  };

  UrlFetchApp.fetch(url, options);
}
