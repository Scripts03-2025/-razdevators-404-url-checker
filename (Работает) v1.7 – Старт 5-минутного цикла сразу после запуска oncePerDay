/**
 * v1.7 ‚Äì –°—Ç–∞—Ä—Ç 5-–º–∏–Ω—É—Ç–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ oncePerDay
 * 
 * –¢–µ–ø–µ—Ä—å —Å—É—Ç–æ—á–Ω—ã–π –∑–∞–ø—É—Å–∫ –Ω–µ –ø—Ä–æ—Å—Ç–æ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç A1/B1, –∞ —Å—Ä–∞–∑—É –∑–∞–ø—É—Å–∫–∞–µ—Ç —Ü–∏–∫–ª!
 */

function checkUrls_v1_4() {
  const sheetName = "404 (–Ω–µ –º–µ–Ω—è—Ç—å!)";
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(sheetName);
  const props = PropertiesService.getScriptProperties();
  const runType = props.getProperty("nextRunType");

  if (runType === "oncePerDay") {
    sheet.getRange("A1").setValue(7);
    sheet.getRange("B1").setValue("");
    props.deleteProperty("nextRunType");
    createTriggerEvery5Minutes(); // üî• –í–ê–ñ–ù–û: —Ç–µ–ø–µ—Ä—å —Ü–∏–∫–ª —Å—Ä–∞–∑—É —Å—Ç–∞—Ä—Ç—É–µ—Ç
    Logger.log("–ú–µ—Ç–∫–∞ oncePerDay –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞. –°–±—Ä–æ—Å B1/A1. –ù–æ–≤—ã–π —Ü–∏–∫–ª –Ω–∞—á–∞—Ç + —Å—Ç–∞—Ä—Ç 5-–º–∏–Ω—É—Ç–Ω–æ–≥–æ —Ç—Ä–∏–≥–≥–µ—Ä–∞.");
  }

  const statusCell = sheet.getRange("B1").getValue();
  if (statusCell === "–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞") {
    removeTrigger("checkUrls_v1_4");
    createTriggerOncePerDay();
    Logger.log("–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –°—Ç–∞–≤–∏–º —Ç—Ä–∏–≥–≥–µ—Ä –Ω–∞ –∑–∞–≤—Ç—Ä–∞.");
    return;
  }

  const startRow = parseInt(sheet.getRange("A1").getValue()) || 7;
  const urls = sheet.getRange(`B${startRow}:B`).getValues().flat();
  const maxChecks = 30;
  let checked = 0;
  let rowIndexes = [];

  for (let i = 0; i < urls.length && checked < maxChecks; i++) {
    const url = urls[i];
    if (!url) continue;
    const row = startRow + i;
    rowIndexes.push(row);

    let code = "", status = "", color = null;

    try {
      const response = UrlFetchApp.fetch(url, {
        muteHttpExceptions: true,
        followRedirects: true,
        timeout: 10
      });

      code = response.getResponseCode();

      if (code === 200) {
        status = "OK";
        color = "#d9ead3";
      } else if (code === 404) {
        status = "Not found";
        color = "#f4cccc";
      } else {
        status = `Code: ${code}`;
        color = "#fff2cc";
      }
    } catch (e) {
      code = "timeout";
      status = "–Ω–µ —É—Å–ø–µ–ª–∏";
      color = "#fce5cd";
    }

    sheet.getRange(`D${row}`).setValue(code);
    sheet.getRange(`E${row}`).setValue(
      Utilities.formatDate(new Date(), Session.getScriptTimeZone(), "HH:mm:ss/dd, MM, yyyy")
    );
    sheet.getRange(`D${row}`).setBackground(color).setNote(status);

    checked++;
  }

  if (checked === 0) {
    sheet.getRange("A1").setValue(7);
    sheet.getRange("B1").setValue("–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞");
    removeTrigger("checkUrls_v1_4");
    createTriggerOncePerDay();
    Logger.log("–í—Å–µ —Å—Å—ã–ª–∫–∏ –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å. –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∞ –Ω–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ —Å—É—Ç–∫–∏.");
    return;
  }

  const lastRowChecked = rowIndexes[rowIndexes.length - 1];
  sheet.getRange("A1").setValue(lastRowChecked + 1);

  const triggers = ScriptApp.getProjectTriggers();
  const has5MinTrigger = triggers.some(t => t.getHandlerFunction() === "checkUrls_v1_4" && t.getEventType() === ScriptApp.EventType.CLOCK);

  if (!has5MinTrigger) {
    createTriggerEvery5Minutes();
    Logger.log("–í–æ–∑–æ–±–Ω–æ–≤–ª—ë–Ω 5-–º–∏–Ω—É—Ç–Ω—ã–π —Ü–∏–∫–ª –ø—Ä–æ–≤–µ—Ä–∫–∏.");
  }
}

function removeTrigger(functionName) {
  const triggers = ScriptApp.getProjectTriggers();
  for (const trigger of triggers) {
    if (trigger.getHandlerFunction() === functionName) {
      ScriptApp.deleteTrigger(trigger);
    }
  }
}

function createTriggerEvery5Minutes() {
  ScriptApp.newTrigger("checkUrls_v1_4")
    .timeBased()
    .everyMinutes(5)
    .create();
}

function createTriggerOncePerDay() {
  PropertiesService.getScriptProperties().setProperty("nextRunType", "oncePerDay");
  ScriptApp.newTrigger("checkUrls_v1_4")
    .timeBased()
    .at(new Date(Date.now() + 24 * 60 * 60 * 1000))
    .create();
}

/**
 * üìÑ –õ–æ–≥ –≤–µ—Ä—Å–∏–π (24.03.2025)
 * | –í–µ—Ä—Å–∏—è | –î–∞—Ç–∞       | –ß—Ç–æ –Ω–æ–≤–æ–≥–æ                                                                 | –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ                                  |
 * |---------|------------|----------------------------------------------------------------------------------|-----------------------------------------------|
 * | v1.0    | 24.03.2025 | –ë–∞–∑–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Å—ã–ª–æ–∫, –ª–æ–≥ –≤ D –∏ E                                      | –°–∫–∞–Ω 30 —Å 7-–π —Å—Ç—Ä–æ–∫–∏                   |
 * | v1.1    | 24.03.2025 | –ü—Ä–∏–≤—è–∑–∫–∞ –∫ –≤–∫–ª–∞–¥–∫–µ "404 (–Ω–µ –º–µ–Ω—è—Ç—å!)"                                   | –†–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å –Ω–µ–π               |
 * | v1.2    | 24.03.2025 | –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∫—Ä–∏–ø—Ç–∞, –µ—Å–ª–∏ –≤ B1 "–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"         | –ù–µ —Ç—Ä–∞—Ç–∏—Ç –ª–∏–º–∏—Ç—ã                  |
 * | v1.3    | 24.03.2025 | –°–∫—Ä–∏–ø—Ç —Å–∞–º —É–¥–∞–ª—è–µ—Ç —Ç—Ä–∏–≥–≥–µ—Ä, –µ—Å–ª–∏ –≤—Å—ë –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ        | –ó–∞—â–∏—Ç–∞ –æ—Ç —Å–∂–∏–≥–∞–Ω–∏—è –ª–∏–º–∏—Ç–æ–≤   |
 * | v1.4    | 24.03.2025 | –ü–æ–ª–Ω—ã–π –∞–≤—Ç–æ—Ü–∏–∫–ª: –∑–∞–ø—É—Å–∫, 24—á –æ—Ç–¥—ã—Ö, –ø–æ–≤—Ç–æ—Ä                         | –ß–∏—Å—Ç—ã–π –∞–≤—Ç–æ–ø–∏–ª–æ—Ç                    |
 * | v1.5    | 24.03.2025 | –°–±—Ä–æ—Å A1/B1 –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Å—É—Ç–æ—á–Ω–æ–≥–æ —Ç—Ä–∏–≥–≥–µ—Ä–∞                   | –ê–≤—Ç–æ-–ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ —Ü–∏–∫–ª—É                |
 * | v1.6    | 24.03.2025 | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω ScriptProperties –¥–ª—è —á—ë—Ç–∫–æ–≥–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è oncePerDay   | –ë–æ–ª—å—à–µ –Ω–µ –ø—É—Ç–∞–µ—Ç—Å—è –≤ —Ç—Ä–∏–≥–≥–µ—Ä–∞—Ö           |
 * | v1.7    | 24.03.2025 | –¶–∏–∫–ª 5 –º–∏–Ω—É—Ç —Å—Ç–∞—Ä—Ç—É–µ—Ç —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ oncePerDay                        | –ù–µ –∂–¥—ë—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è, —Å—Ç–∞—Ä—Ç—É–µ—Ç —Å–∞–º       |
 */
